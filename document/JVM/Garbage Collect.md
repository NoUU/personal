# Garbage Collect （垃圾回收）

## 1.1 如何确定一个对象是垃圾

### 1.1.1 引用计数法

> 对于一个对象而言，只要应用程序中持有该对象的引用，就说明该对象不是垃圾，如果一个对象没有任何指引对其引用，它就是垃圾

弊端：如果AB两个对象相互持有引用，导致永远不能被回收。

### 1.1.2 可达性分析

通过 GC Root 的对象，开始向下寻找，看某个对象是否可达

> 可作为 GC Root 的对象：类加载器，Thread，虚拟机栈的局部变量，static 成员，常量引用，本地方法栈的变量等。

虚拟机栈的局部变量 <---- 栈帧 <---- 栈 <---- 正在执行线程

static 变量、常量引用：不随对象的生命周期而创建或销毁，会很长一段时间存在于方法区中



Java 进程中的堆内容导出，heap.hprof

## 1.2 垃圾回收算法

### 1.2.1 标记-清除 （Mark-Sweep）

1. 标记

找出内存中需要回收的对象，并且把它们标记出来

> 堆中所有的对象都会被扫描一遍，从而确定需要回收的对象，扫描过程比较耗时。

2. 清除

清除掉被标记的需要回收的对象，释放内存空间

3. 缺点

* 标记和清除两个过程都比较耗时，效率不高
* 标记清除之后，会产生大量不连续的内存碎片，空间碎片太多会导致在程序运行过程中，需要分配较大对象时，无法找到足够的内存连续的空间，而不得不提前触发下一次垃圾收集动作

### 1.2.2 复制算法 （Copying）

将内存划分为两块大小相等的区域，每次只使用其中的一块，当其中一块内存使用完，就将还存活的对象复制到另一块上，清空第一块，使用另一块。

缺点：空间利用率低。

### 1.2.3 标记-整理 （Mark-Compact）

标记过程与“标记-清除”算法中的标记过程一样，但后续步骤不是直接对可回收对象进行清理，而是将所有存活的对象向一端移动，然后清理掉端边界以外的内存

## 1.3 分代收集算法

Young 区：复制算法（对象在被分配内存后，生命周期比较短，朝生夕死，Young 区复制效率比较高）

Old 区：标记清除或者标记整理算法（Old 区对象存活时间比较长，标记后进行下一步的清理）

## 1.4  垃圾收集器

### 1.4.1 Serial 收集器

Serial 收集器是一种单线程收集器，只会使用一个 CPU  或者一个线程去完成垃圾收集工作，进行垃圾回收时需要暂停其他线程

````
优点：简单高效，拥有很高的单线程收集效率
缺点：收集过程中老板娘暂停所有线程
算法：复制算法
适用范围：新生代
应用：Client 模式下的默认新生代收集器
````

### 1.4.2 ParNew 收集器

可以理解为 Serial 收集器的多线程版本

````
优点：在多 CPU 时，比 Serial 效率高
缺点：收集过程中需要暂停所有线程，单 CPU 时效率比 Serial 低
算法：复制算法
适用范围：新生代
应用：运行在 Server 模式下的虚拟机中首选的新生代收集器
````

### 1.4.3 Parallel Scavenge 收集器

新生代收集器，也是使用复制算法的并行的多线程收集器。Parallel Scavenge 更关注 系统的 **吞吐量**

> 吞吐量：运行用户代码的时间 / （运行用户代码的时间 + 垃圾收集时间）
>
> 比如虚拟机总共运行了100分钟，垃圾收集时间为1分钟。吞吐量 =  （100 - 1）/ 100 = 99%

````
-XX:MaxGCPauseMillis    //垃圾收集最长停顿时间
-XX:GCTimeRatio			//吞吐量大小
````

### 1.4.4 Serial Old 收集器

一个单线程 Old 区的收集器，采用 **“标记-整理”** 算法，运行过程和 Serial 收集器相同

### 1.4.5 Parallel Old 收集器

Parallel Scavenge 收集器的 Old 区版本，使用 **多线程** 和 **"标记-整理"** 算法

吞吐量优先

### 1.4.6 CMS 收集器 （Concurrent Mark Sweep）

以 **最短停顿时间** 为目标的收集器，采用的是 **“标记-清除”** 算法

> 1. 初始标记 	CMS initial mark  		    标记 GC Root 能关联的对象  STW 速度很快
> 2. 并发标记 	CMS concurrent mark    进行 GC Root Tracing
> 3. 重新标记	 CMS remark   修改并发标记因用户程序变动的内容 STW 
> 4. 并发清除	 CMS concurrent sweep 